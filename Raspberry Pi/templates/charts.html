<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Charts - {{ name }}</title>
    <link rel="stylesheet" href="/static/style.css">
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <header>
        <h1>Charts — {{ name }}</h1>
        <p style="text-align:center;">Device: {{ mac }}</p>
    </header>

    <main style="max-width:1000px;margin:0 auto;padding:16px;">
        <canvas id="tempChart" height="120"></canvas>
        <canvas id="humChart" height="120" style="margin-top:24px;"></canvas>
        <canvas id="moistChart" height="120" style="margin-top:24px;"></canvas>
    </main>

<script>
const mac = "{{ mac }}";

async function fetchHistory() {
    const res = await fetch('/api/history/' + encodeURIComponent(mac));
    const data = await res.json();
    if (data.status !== 'ok') return [];
    return data.history;
}

function buildDatasets(history) {
    const labels = history.map(p => p.ts);
    const temp = history.map(p => p.TEMP);
    const hum = history.map(p => p.HUM);
    const moist = history.map(p => p.MOIST);
    return { labels, temp, hum, moist };
}

function createChart(ctx, labels, data, label, yLabel) {
    return new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: label,
                data: data,
                fill: false,
                tension: 0.2,
                pointRadius: 2
            }]
        },
        options: {
            scales: {
                x: { ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 12 } },
                y: { title: { display: true, text: yLabel } }
            },
            plugins: {
                legend: { display: true }
            },
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

let tempChart, humChart, moistChart;

async function draw() {
    const history = await fetchHistory();
    const ds = buildDatasets(history);

    const tctx = document.getElementById('tempChart').getContext('2d');
    const hctx = document.getElementById('humChart').getContext('2d');
    const mctx = document.getElementById('moistChart').getContext('2d');

    if (tempChart) tempChart.destroy();
    if (humChart) humChart.destroy();
    if (moistChart) moistChart.destroy();

    tempChart = createChart(tctx, ds.labels, ds.temp, 'Temperature (°C)', '°C');
    humChart = createChart(hctx, ds.labels, ds.hum, 'Humidity (%)', '%');
    moistChart = createChart(mctx, ds.labels, ds.moist, 'Soil Moisture', 'value');
}

draw();
// refresh charts every 10 seconds
setInterval(draw, 10000);
</script>
</body>
</html>
