<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Crop Monitor</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <header>
        <h1>Crop Monitor Dashboard</h1>
    </header>

    <main id="cards">
        {% if devices|length == 0 %}
            <p style="text-align:center;">No devices connected yet.</p>
        {% endif %}

        {% for mac, info in devices.items() %}
        <section class="card {% if not info['online'] %}offline{% endif %}">
            <div class="card-header">
                <h2 class="device-name">{{ info['name'] }}</h2>
                <span class="mac">{{ mac }}</span>
            </div>

            <div class="card-body">
                {% if info['online'] %}
                    <div class="row"><strong>Temperature:</strong> {{ info['TEMP'] }}°C</div>
                    <div class="row"><strong>Humidity:</strong> {{ info['HUM'] }}%</div>
                    <div class="row"><strong>Soil Moisture:</strong> {{ info['MOIST'] }}</div>
                    <div class="row"><strong>Soil Temp:</strong> {{ info['SOILT'] }}°C</div>
                    <div class="row"><strong>Last seen:</strong> <span class="ts" data-ts="{{ info['last_seen'] }}">{{ info['last_seen'] }}</span></div>
                {% else %}
                    <div class="row"><strong>Last seen:</strong> <span class="ts" data-ts="{{ info['last_seen'] }}">{{ info['last_seen'] }}</span></div>
                {% endif %}
            </div>

            <div class="card-actions">
                <button class="btn on" onclick="toggle('{{ mac }}','pump','ON')">Pump ON</button>
                <button class="btn off" onclick="toggle('{{ mac }}','pump','OFF')">Pump OFF</button>
                <button class="btn on" onclick="toggle('{{ mac }}','light','ON')">Light ON</button>
                <button class="btn off" onclick="toggle('{{ mac }}','light','OFF')">Light OFF</button>
                <button class="btn" onclick="openCharts('{{ mac }}')">Open Charts</button>
            </div>

            <div class="rename">
                <input type="text" id="name-{{ mac }}" placeholder="Rename device" />
                <button class="btn" onclick="renameDevice('{{ mac }}')">Save</button>
            </div>
        </section>
        {% endfor %}
    </main>

<script>
// toggle pump/light
function toggle(mac, device, state) {
    fetch('/control', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ mac: mac, device: device, state: state })
    });
}

// rename
function renameDevice(mac) {
    const input = document.getElementById('name-' + mac);
    const name = input.value.trim();
    if (!name) return;
    fetch('/rename', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ mac: mac, name: name })
    }).then(()=>location.reload());
}

// open charts in a new window
function openCharts(mac) {
    window.open('/charts/' + encodeURIComponent(mac), '_blank', 'width=900,height=700');
}

// friendly timestamp formatting
function fmtRelative(ts) {
    // ts expected as "YYYY-MM-DD HH:MM:SS" in local timezone
    const parts = ts.split(' ');
    if (parts.length < 2) return ts;
    const datePart = parts[0].split('-');
    const timePart = parts[1].split(':');
    const dt = new Date(
        parseInt(datePart[0]), parseInt(datePart[1])-1, parseInt(datePart[2]),
        parseInt(timePart[0]), parseInt(timePart[1]), parseInt(timePart[2])
    );
    // relative text
    const now = new Date();
    const diff = Math.floor((now - dt) / 1000); // seconds
    if (diff < 5) return "just now";
    if (diff < 60) return diff + "s ago";
    if (diff < 3600) return Math.floor(diff/60) + "m ago";
    if (diff < 86400) return Math.floor(diff/3600) + "h ago";
    // else show date short
    return dt.toLocaleString();
}

function updateTimestamps() {
    document.querySelectorAll('.ts').forEach(el => {
        const ts = el.getAttribute('data-ts');
        if (ts) el.textContent = fmtRelative(ts);
    });
}

updateTimestamps();
setInterval(updateTimestamps, 5000);

// auto-refresh periodically to update statuses
setInterval(() => { location.reload(); }, 15000);
</script>
</body>
</html>
